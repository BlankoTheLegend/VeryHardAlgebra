<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VeryHardAlgebra Hub</title>
<style>
body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
#hubDiv, #chatDiv, #curtainsDiv { max-width: 600px; margin: auto; display: none; }
#messages { border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px; background: #f9f9f9; }
input, button { width: 100%; margin: 5px 0; padding: 10px; box-sizing: border-box; }
#status, #statusChat { margin-bottom: 10px; }
iframe { width: 100%; height: 80vh; border: none; }
</style>
</head>
<body>

<!-- Master password login -->
<div id="loginMasterDiv">
  <h2>Login to VeryHardAlgebra</h2>
  <input type="password" id="masterPassword" placeholder="Enter master password">
  <button id="masterLoginBtn">Login</button>
  <p id="errorMessage" style="color:red;"></p>
</div>

<!-- Hub menu -->
<div id="hubDiv">
  <h2>Welcome!</h2>
  <button id="openCurtainsBtn">Open Curtains</button>
  <button id="openChatBtn">Open Chat App</button>
</div>

<!-- Chat App -->
<div id="chatDiv">
  <div id="loginDiv">
    <h2>Login to Chat</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn">Login</button>
    <p id="loginStatus"></p>
    <p id="status">Disconnected</p>
  </div>
  <div id="chatContentDiv" style="display:none;">
    <h2>Chat</h2>
    <div id="messages"></div>
    <input type="text" id="msgInput" placeholder="Type a message">
    <button id="sendBtn">Send</button>
    <p id="statusChat">Disconnected</p>
  </div>
</div>

<!-- Curtains App -->
<div id="curtainsDiv" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999;">
  <iframe id="curtainsFrame" sandbox="allow-scripts allow-forms allow-same-origin" style="width:100%; height:100%; border:none;"></iframe>
</div>

<script>
// ---------------- Master Password Login ----------------
const masterLoginBtn = document.getElementById('masterLoginBtn');
const loginMasterDiv = document.getElementById('loginMasterDiv');
const hubDiv = document.getElementById('hubDiv');
const errorMessage = document.getElementById('errorMessage');

masterLoginBtn.addEventListener('click', () => {
  const pwd = document.getElementById('masterPassword').value;
  if (pwd === 'Zahir') {
    loginMasterDiv.style.display = 'none';
    hubDiv.style.display = 'block';
  } else {
    errorMessage.textContent = 'Incorrect password. Please try again.';
  }
});

// ---------------- Hub Buttons ----------------
const openChatBtn = document.getElementById('openChatBtn');
const openCurtainsBtn = document.getElementById('openCurtainsBtn');
const chatDiv = document.getElementById('chatDiv');
const curtainsDiv = document.getElementById('curtainsDiv');

openChatBtn.addEventListener('click', () => {
  hubDiv.style.display = 'none';
  chatDiv.style.display = 'block';
});

openCurtainsBtn.addEventListener('click', () => {
  hubDiv.style.display = 'none';
  curtainsDiv.style.display = 'block';
  loadCurtains();
});

// ---------------- Chat App ----------------
let ws = null;
let username = null;

async function getServerURL() {
  try {
    const res = await fetch('https://raw.githubusercontent.com/BlankoTheLegend/VeryHardAlgebra/refs/heads/main/Key.txt');
    return (await res.text()).trim();
  } catch(e) {
    alert('Failed to fetch chat server URL');
  }
}

async function initWebSocket() {
  if (ws && ws.readyState === WebSocket.OPEN) return;
  const serverURL = await getServerURL();
  if (!serverURL) return;

  ws = new WebSocket(serverURL);
  ws.onopen = () => updateStatus('Connected');
  ws.onclose = () => updateStatus('Disconnected');
  ws.onerror = () => updateStatus('Error');

  ws.onmessage = msg => {
    const data = JSON.parse(msg.data);
    if (data.type === 'login') {
      if (data.success) {
        document.getElementById('loginDiv').style.display = 'none';
        document.getElementById('chatContentDiv').style.display = 'block';
      } else {
        document.getElementById('loginStatus').innerText = 'Login failed';
      }
    }
    if (data.type === 'message') {
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML += `<div><b>${data.user}:</b> ${data.text}</div>`;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  };
}

function updateStatus(text) {
  document.getElementById('status').innerText = text;
  document.getElementById('statusChat').innerText = text;
}

function login() {
  username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  if (!username || !password) return alert('Enter username and password');
  initWebSocket().then(() => {
    ws.send(JSON.stringify({ type: 'login', username, password }));
  });
}

document.getElementById('loginBtn').addEventListener('click', login);
document.getElementById('loginBtn').addEventListener('touchend', login);
document.getElementById('sendBtn').addEventListener('click', () => {
  const text = document.getElementById('msgInput').value.trim();
  if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
  ws.send(JSON.stringify({ type: 'message', text }));
  document.getElementById('msgInput').value = '';
});
document.getElementById('sendBtn').addEventListener('touchend', () => {
  document.getElementById('sendBtn').click();
});

// ---------------- Curtains Loader ----------------
const curtainsFrame = document.getElementById('curtainsFrame');

async function loadCurtains() {
  const RAW_URL = 'https://raw.githubusercontent.com/BlankoTheLegend/VeryHardAlgebra/refs/heads/main/Curtains.html';

  function openDatabase() {
    return new Promise((resolve, reject) => {
      const request = indexedDB.open('VeryHardAlgebraDB', 1);
      request.onupgradeneeded = (event) => {
        const db = event.target.result;
        if (!db.objectStoreNames.contains('htmlCache')) db.createObjectStore('htmlCache');
      };
      request.onsuccess = () => resolve(request.result);
      request.onerror = () => reject(request.error);
    });
  }

  function saveHtmlToDB(html) {
    return openDatabase().then(db => {
      const tx = db.transaction('htmlCache', 'readwrite');
      tx.objectStore('htmlCache').put(html, 'Curtains');
      return tx.complete || new Promise(res => tx.oncomplete = res);
    });
  }

  function loadHtmlFromDB() {
    return openDatabase().then(db => {
      return new Promise((resolve, reject) => {
        const tx = db.transaction('htmlCache', 'readonly');
        const req = tx.objectStore('htmlCache').get('Curtains');
        req.onsuccess = () => resolve(req.result);
        req.onerror = () => reject(req.error);
      });
    });
  }

  try {
    const response = await fetch(RAW_URL, { cache: 'no-store' });
    if (!response.ok) throw new Error('Fetch failed');
    const html = await response.text();
    await saveHtmlToDB(html);
    curtainsFrame.srcdoc = html;
    console.log('Loaded Curtains from GitHub');
  } catch (err) {
    console.warn('Fetch failed, trying IndexedDB...');
    try {
      const cached = await loadHtmlFromDB();
      if (cached) curtainsFrame.srcdoc = cached;
      else throw new Error('No cached Curtains found');
    } catch {
      curtainsFrame.src = '/fallback.html';
    }
  }
}
</script>
</body>
</html>
