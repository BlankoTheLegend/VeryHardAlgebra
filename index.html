<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VeryHardAlgebra Hub</title>
<style>
body { margin:0; padding:0; font-family: Arial, sans-serif; }
#loginDiv, #choiceDiv, #chatDiv, #curtainsDiv { display: none; position: fixed; top:0; left:0; width:100vw; height:100vh; background:#f0f0f0; justify-content:center; align-items:center; flex-direction:column; }
#loginDiv, #choiceDiv { display:flex; }
input, button { width: 100%; margin: 5px 0; padding: 10px; box-sizing: border-box; font-size:16px; }
#messages { border:1px solid #ccc; height:300px; overflow-y:scroll; padding:10px; background:#f9f9f9; width:90%; max-width:500px; }
iframe { width:100%; height:100%; border:none; }
#status, #statusChat, #loginStatus { margin-bottom:10px; }
</style>
</head>
<body>

<!-- Master Login -->
<div id="loginDiv">
  <h2>Enter Master Password</h2>
  <input type="password" id="masterPassword" placeholder="Password">
  <button id="masterLoginBtn">Login</button>
  <p id="masterError" style="color:red;"></p>
</div>

<!-- Choice between Curtains or Chat -->
<div id="choiceDiv">
  <h2>Welcome! Choose an option:</h2>
  <button id="openCurtainsBtn">Open Curtains</button>
  <button id="openChatBtn">Open Chat App</button>
</div>

<!-- Chat App -->
<div id="chatDiv">
  <div id="loginDivChat">
    <h2>Login</h2>
    <input type="text" id="username" placeholder="Username">
    <input type="password" id="password" placeholder="Password">
    <button id="loginBtn">Login</button>
    <p id="loginStatus"></p>
    <p id="status">Disconnected</p>
  </div>
  <div id="chatBox" style="display:none; flex-direction:column; align-items:center;">
    <h2>Chat</h2>
    <div id="messages"></div>
    <input type="text" id="msgInput" placeholder="Type a message">
    <button id="sendBtn">Send</button>
    <p id="statusChat">Disconnected</p>
  </div>
</div>

<!-- Curtains -->
<div id="curtainsDiv">
  <iframe id="curtainsFrame" sandbox="allow-scripts allow-forms allow-same-origin"></iframe>
</div>

<script>
// --- Master Password ---
const masterLoginBtn = document.getElementById('masterLoginBtn');
const masterPasswordInput = document.getElementById('masterPassword');
const masterError = document.getElementById('masterError');

masterLoginBtn.addEventListener('click', () => {
  if (masterPasswordInput.value === 'SabrinaC') {
    document.getElementById('loginDiv').style.display = 'none';
    document.getElementById('choiceDiv').style.display = 'flex';
  } else {
    masterError.textContent = 'Incorrect password';
  }
});

// --- Choice Buttons ---
document.getElementById('openCurtainsBtn').addEventListener('click', () => {
  document.getElementById('choiceDiv').style.display = 'none';
  document.getElementById('curtainsDiv').style.display = 'flex';
  loadCurtains();
});

document.getElementById('openChatBtn').addEventListener('click', () => {
  document.getElementById('choiceDiv').style.display = 'none';
  document.getElementById('chatDiv').style.display = 'flex';
});

// --- Curtains ---
function loadCurtains() {
  const RAW_URL = 'https://raw.githubusercontent.com/BlankoTheLegend/VeryHardAlgebra/refs/heads/main/Curtains.html';
  fetch(RAW_URL)
    .then(res => res.text())
    .then(html => {
      document.getElementById('curtainsFrame').srcdoc = html;
    })
    .catch(() => alert('Failed to load Curtains'));
}

// --- Chat App ---
let ws = null;
let username = null;

async function getServerURL() {
  try {
    const res = await fetch('https://raw.githubusercontent.com/BlankoTheLegend/VeryHardAlgebra/refs/heads/main/Key.txt');
    return (await res.text()).trim();
  } catch(e) {
    alert('Failed to fetch chat server URL');
  }
}

async function initWebSocket() {
  if (ws) return;
  const serverURL = await getServerURL();
  if (!serverURL) return;
  ws = new WebSocket(serverURL);

  ws.onopen = () => { updateStatus('Connected'); };
  ws.onclose = () => { updateStatus('Disconnected'); };
  ws.onerror = () => { updateStatus('Error'); };

  ws.onmessage = msg => {
    const data = JSON.parse(msg.data);
    if (data.type === 'login') {
      if (data.success) {
        document.getElementById('loginDivChat').style.display = 'none';
        document.getElementById('chatBox').style.display = 'flex';
      } else {
        document.getElementById('loginStatus').innerText = 'Login failed';
      }
    }
    if (data.type === 'message') {
      const messagesDiv = document.getElementById('messages');
      messagesDiv.innerHTML += `<div><b>${data.user}:</b> ${data.text}</div>`;
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
  };
};

function updateStatus(text) {
  document.getElementById('status').innerText = text;
  document.getElementById('statusChat').innerText = text;
}

function login() {
  username = document.getElementById('username').value;
  const password = document.getElementById('password').value;
  if (!username || !password) return alert('Enter username and password');
  initWebSocket().then(() => {
    ws.send(JSON.stringify({ type:'login', username, password }));
  });
}

document.getElementById('loginBtn').addEventListener('click', login);
document.getElementById('loginBtn').addEventListener('touchend', login);

document.getElementById('sendBtn').addEventListener('click', () => {
  const text = document.getElementById('msgInput').value.trim();
  if (!text || !ws || ws.readyState !== WebSocket.OPEN) return;
  ws.send(JSON.stringify({ type:'message', text }));
  document.getElementById('msgInput').value = '';
});
document.getElementById('sendBtn').addEventListener('touchend', () => {
  document.getElementById('sendBtn').click();
});
</script>

</body>
</html>
